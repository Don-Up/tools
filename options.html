<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Options</title>

    <!-- Prism æš—é»‘ä¸»é¢˜ -->
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background: #121212;
            color: #e0e0e0;
            padding: 0 25% 30px;
        }

        h2 {
            text-align: center;
            color: #90caf9;
            font-size: 40px;
        }

        .paste-hint {
            text-align: center;
            color: #aaa;
            margin-bottom: 20px;
            font-style: italic;
        }

        .options {
            background: #1e1e1e;
            padding: 16px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            margin-bottom: 30px;
            transition: background 0.3s;
        }

        .options:hover {
            background: #252525;
        }

        pre {
            background: #1e1e1e;
            border-radius: 4px;
            padding: 12px;
            overflow-x: auto;
        }

        select {
            background-color: #1e1e1e; /* Dark background */
            color: #e0e0e0;           /* Light text */
            border: 1px solid #333;   /* Subtle border */
            border-radius: 4px;       /* Slightly rounded corners */
            padding: 5px;             /* Internal spacing */
        }
        /* Optionally, style the options within the dropdown if needed */
        /* Note: Styling options can be limited in some browsers */
        select option {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        #rate-slider {
            width: 100%;
            margin-top: 10px;
            margin-bottom: 20px;
            /* Basic dark theme styles for range input */
            background-color: #121212; /* Background of the track */
        }

        #rate-slider::-webkit-slider-runnable-track { /* Chrome, Safari, Opera */
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            height: 8px;
        }
        #rate-slider::-moz-range-track { /* Firefox */
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            height: 8px;
        }

        #rate-slider::-webkit-slider-thumb { /* Chrome, Safari, Opera */
            -webkit-appearance: none;
            appearance: none;
            background: #90caf9; /* Blue thumb */
            border-radius: 50%;
            width: 18px;
            height: 18px;
            margin-top: -5px; /* Center vertically */
        }
        #rate-slider::-moz-range-thumb { /* Firefox */
            background: #90caf9; /* Blue thumb */
            border-radius: 50%;
            width: 18px;
            height: 18px;
            border: none;
        }

        #rate-value {
            margin-left: 10px;
            color: #90caf9;
        }

        button { /* Or a more specific selector like #content button if needed */
            margin-left: 10px;
            background-color: #66afe9;
            color: white;
            border: none;
            width: 42px;
            text-align: center;
            height: 22px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 12px;
        }

        /* Style for copy buttons inside pre elements */
        pre {
            position: relative; /* Ensure parent has relative positioning */
        }

        .copy-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #66afe9;
            color: white;
            border: none;
            border-radius: 4px;
            width: 55px;
            height: 22px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 10px;
            margin-top: 10px;
        }

        .copy-button:hover {
            background-color: #4d9fe0; /* Slightly darker on hover */
        }


    </style>
</head>
<body>

<h2>ðŸŒ™ Options</h2>
<div style="display: flex;height: 30px;align-items: center;">
    <select id="voice-select">
    </select>
    <div style="margin-left: 20px; display: flex;margin-top: 10px;">
        <label for="rate-slider">Speed:</label>
        <input type="range" id="rate-slider" min="0.5" max="2" step="0.1" value="1" style="margin-left: 10px;">
        <span id="rate-value">1.0</span>
    </div>
</div>
<div id="content"></div>

<!-- Prism Core -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>

<!-- Prism Language Packs -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script> <!-- HTML -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>    <!-- CSS -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script> <!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-typescript.min.js"></script> <!-- TS -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-jsx.min.js"></script>  <!-- JSX -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-tsx.min.js"></script>  <!-- TSX -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>


<script>
    // é»˜è®¤å‘éŸ³äººåç§°
    const defaultVoiceName = localStorage.getItem('selectedVoice') || "Microsoft Brian Online (Natural) - English (United States)";

    document.addEventListener('paste', e => {
        const htmlData = e.clipboardData.getData('text/html') || e.clipboardData.getData('text/plain');
        if (!htmlData) return;

        const container = document.getElementById('content');
        container.innerHTML = '';
        container.innerHTML = htmlData.trim();

        initializeQuestions();
        // document.querySelectorAll('pre code').forEach(code => {
        //     code.textContent = code.textContent.replace(/^\s*\n/, '');
        // });
        Prism.highlightAll();
        // å›žåˆ°é¡¶éƒ¨
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    let isSpeaking = false;
    const select = document.getElementById('voice-select');
    select.innerHTML = '<option value="">Loading...</option>';
    // Event listener for when the user manually selects a voice from the dropdown
    select.addEventListener('change', () => {
        const selectedVoiceName = select.value;
        localStorage.setItem('selectedVoice', selectedVoiceName);
        const voices = window.speechSynthesis.getVoices();
        const voice = voices.find(voice => voice.name === selectedVoiceName);
        if (voice) {
            selectVoice = voice;
        }
    });

    document.addEventListener("keydown",  (e) => {
        console.log(e.key)
        if (e.keyCode === 32) {
            e.preventDefault();
            window.speechSynthesis.cancel();
            isSpeaking = false;
        } else if (e.key === 'd'){
            e.preventDefault();
            // æš‚åœ/ç»§ç»­
            if (!isSpeaking) {
                isSpeaking = true;
                window.speechSynthesis.resume();
            } else {
                isSpeaking = false;
                window.speechSynthesis.pause();
            }
        }
    })

    let selectVoice = null
    let currentRate = parseFloat(localStorage.getItem('speechRate')) || 1.0; // Load saved rate or default to 1.0

    document.addEventListener('DOMContentLoaded', () => {
        const rateSlider = document.getElementById('rate-slider');
        const rateValueSpan = document.getElementById('rate-value');

        if (rateSlider && rateValueSpan) {
            rateSlider.value = currentRate;
            rateValueSpan.textContent = currentRate.toFixed(1);

            rateSlider.addEventListener('input', () => {
                currentRate = parseFloat(rateSlider.value);
                rateValueSpan.textContent = currentRate.toFixed(1);
                localStorage.setItem('speechRate', currentRate); // Save the preference
            });
        }
    });

    window.speechSynthesis.onvoiceschanged = () => {
        const voices = window.speechSynthesis.getVoices();

        // Clear any existing options (like the "Loading..." one)
        select.innerHTML = '';

        // Populate the select element with available voices
        voices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.name;
            option.textContent = voice.name; // Or voice.name + ' (' + voice.lang + ')'
            select.appendChild(option);

            // Check if this is the default voice and store it
            if (voice.name === defaultVoiceName) {
                selectVoice = voice;
            }
        });

        // Set the default selected option in the dropdown if the default voice was found
        if (selectVoice) {
            select.value = selectVoice.name;
        }
    };

    function speak(text){
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = currentRate; // ä½¿ç”¨å½“å‰è¯­é€Ÿ
        utterance.voice = selectVoice;
        utterance.onstart = () => {
            isSpeaking = true;
        };
        utterance.onend = () => {
            isSpeaking = false;
        }
        speechSynthesis.speak(utterance);
    }


    function initializeQuestions() {
        document.querySelectorAll('.options').forEach((container, qIndex) => {
            if (container.dataset.processed === 'true') return;
            container.dataset.processed = 'true';

            container.style.marginTop = "30px"

            const originalAnswer = Number(container.dataset.answer);
            if (isNaN(originalAnswer) || originalAnswer < 1) return;

            const children = Array.from(container.children);
            if (children.length < 2) return;

            const question = children[0];

            const explainDiv = container.querySelector(".explain")
            if(explainDiv){
                explainDiv.style.display = "none"
            }

            let optionElements = children.filter(child => !child.classList.contains('explain')).slice(1);
            optionElements.forEach((opt, i) => {
                opt.dataset.origIndex = i;
                opt.textContent = opt.textContent.replace(/^\d+\.\s*/, '').trim();
            });

            const shouldShuffle = container.dataset.shuffle !== 'false';
            if (shouldShuffle) {
                for (let i = optionElements.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [optionElements[i], optionElements[j]] = [optionElements[j], optionElements[i]];
                }
                optionElements.forEach(opt => container.appendChild(opt));
            }

            if (explainDiv) {
                // explainDiv.style.fontStyle = "italic"
                container.appendChild(explainDiv);
            }

            const displayOptions = Array.from(container.children).slice(1);

            const correctOrigIndex = originalAnswer - 1;
            const newAnswerIndex = displayOptions.findIndex(opt =>
                Number(opt.dataset.origIndex) === correctOrigIndex
            ) + 1;
            container.dataset.answer = String(newAnswerIndex);

            displayOptions.forEach((opt, i) => {
                const cleanText = opt.textContent.trim();
                opt.textContent = opt.className === 'explain' ? cleanText : `${i + 1}. ${cleanText}`;
            });

            question.style.fontWeight = 'bold';
            question.style.margin = '5px 0px 15px 0';
            question.style.color = '#bbdefb';
            question.style.fontSize = '25px';
            question.style.cursor = 'pointer';
            question.style.display = 'flex'
            question.style.alignItems = 'center';

            question.addEventListener("click", (event) => {
                event.stopPropagation();
                speak(textToCopy)
            })

            // åˆ›å»ºä¸€ä¸ªbutton
            const copyButton = document.createElement('button');
            copyButton.textContent = 'Copy';
            const questionText = question.textContent.trim();
            const optionsText = displayOptions.map((opt, displayIdx) => {
                const cleanText = opt.textContent.trim();
                return opt.className === "explain" ? "" : `${cleanText}`;// ${displayIdx + 1}.
            }).join('\n');
            const textToCopy = `${questionText}\n${optionsText}`;

            question.textContent = `${qIndex+1}. ${questionText}`;

            copyButton.addEventListener("click", (event) => {
                event.stopPropagation();
                // å¤åˆ¶é—®é¢˜å’Œé€‰é¡¹
                navigator.clipboard.writeText(textToCopy).then(() => {
                }).catch(err => {
                    alert("Failed to copy: " + err)
                });
            })
            question.appendChild(copyButton);

            const resetButton = document.createElement('button');
            resetButton.textContent = 'Reset';
            resetButton.addEventListener("click", reset)
            question.appendChild(resetButton);

            displayOptions.forEach((opt, displayIdx) => {
                opt.style.padding = '8px 12px';
                opt.style.margin = '4px 0';
                opt.style.border = '1px solid #333';
                opt.style.borderRadius = '6px';
                opt.style.cursor = 'pointer';
                opt.style.transition = 'all 0.3s';
                opt.style.userSelect = 'none';
                opt.style.backgroundColor = '#1e1e1e';
                opt.style.color = '#e0e0e0';
                opt.dataset.selected = "false";

                // Hover æ•ˆæžœï¼šä»…åœ¨æœªè¢«é€‰ä¸­æ—¶ç”Ÿæ•ˆ
                opt.addEventListener('mouseenter', () => {
                    if (opt.dataset.selected === "false") {
                        opt.style.backgroundColor = '#2c2c2c';
                    }
                });
                opt.addEventListener('mouseleave', () => {
                    if (opt.dataset.selected === "false") {
                        opt.style.backgroundColor = '#1e1e1e';
                    }
                });

                // ç‚¹å‡»é€‰é¡¹
                opt.addEventListener('click', () => {
                    if(opt.className === "explain"){
                        speak(opt.textContent)
                        return
                    }

                    window.speechSynthesis.cancel();

                    displayOptions.forEach(o => {
                        o.style.backgroundColor = '#1e1e1e';
                        o.style.color = '#e0e0e0';
                        o.dataset.selected = "false";
                    });

                    const currentAnswer = Number(container.dataset.answer);
                    const isCorrect = (displayIdx + 1) === currentAnswer;

                    if (isCorrect) {
                        opt.style.backgroundColor = '#1b5e20';
                        opt.style.color = '#a5d6a7';
                        // åˆ¤æ–­textæ˜¯å¦åªç”±å­—æ¯, æ•°å­—ï¼Œé€—å·,å¥å·, -, ç©ºæ ¼ç»„æˆ
                        const lastContent = displayOptions[displayOptions.length-1].textContent
                        if (/^[a-zA-Z0-9,.ï¼Œã€‚()\-\s]+$/.test(lastContent)) {
                            speak(lastContent)
                        }
                    } else {
                        opt.style.backgroundColor = '#b71c1c';
                        opt.style.color = '#ffcccb';
                        const correctOpt = displayOptions[currentAnswer - 1];
                        if (correctOpt) {
                            correctOpt.style.backgroundColor = '#1b5e20';
                            correctOpt.style.color = '#a5d6a7';
                            correctOpt.dataset.selected = "true";
                        }
                        if(/^[a-zA-Z0-9,.ï¼Œã€‚\-\s]+$/.test(correctOpt.textContent)){
                            speak("The correct answer is "+ correctOpt.textContent.slice(2))
                        }
                    }

                    opt.dataset.selected = "true"; // æ ‡è®°è¢«é€‰ä¸­
                    explainDiv.style.display = 'block';
                });
            });

        });
        document.querySelectorAll('code').forEach(code => {
            // Ensure the parent 'pre' element has position: relative for absolute positioning of the button
            const pre = code.parentElement;
            if (pre && pre.tagName.toLowerCase() === 'pre') {
                pre.style.position = 'relative';

                // Create the copy button
                const copyButton = document.createElement('button');
                copyButton.textContent = 'Copy';
                copyButton.className = 'copy-button'; // Optional: for easier CSS targeting

                // Add click event to copy code content
                copyButton.addEventListener('click', () => {
                    const textToCopy = code.textContent;
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        // Optional: Provide feedback (e.g., change button text temporarily)
                        const originalText = copyButton.textContent;
                        copyButton.textContent = 'Copied';
                        setTimeout(() => { copyButton.textContent = originalText; }, 1000);
                    }).catch(err => {
                        console.error('Failed to copy code: ', err);
                        alert('Failed to copy code.');
                    });
                });

                // Append the button to the 'pre' element
                pre.appendChild(copyButton);
            }
        });

    }

    function reset(){
        document.querySelectorAll('.options').forEach(container => {
            const options = Array.from(container.children).slice(1);
            options.forEach(opt => {
                opt.style.backgroundColor = '';
                opt.style.color = '';
            });
        });
    }

</script>

</body>
</html>
