<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代码填空题</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        #divContent {
            white-space: pre-wrap;
        }

        input {
            border: 1px solid #ccc;
            padding: 2px;
            font-size: 20px;
            text-align: center;
        }

        input::placeholder {
            color: transparent;
        }

        #container {
            background-color: #000;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #divContent {
            font-size: 20px;
            width: 800px;
            background-color: #2b2b2b;
            margin-left: auto;
            margin-right: auto;
            padding: 40px 100px;
            line-height: 1.5;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        #dialog {
            background: #2b2b2b;
            padding: 20px;
            border-radius: 5px;
            width: 500px;
            position: absolute;
            left: calc(50% - 250px);
            top: calc(50% - 250px);
            display: none;
            border: grey 1px solid;
        }

        #dialog textarea {
            width: 480px;
            height: 200px;
            margin: 0 auto 10px;
            background: #1e1e1e;
            color: #fff;
            border: 1px solid #444;
            padding: 10px;
        }

        .dialog-actions {
            text-align: center;
        }

        p {
            margin-bottom: 0;
            margin-top: 0;
            // 覆盖显示鼠标指针
            cursor: pointer;
        }

        .voice-select {
            width: 320px;
            padding: 5px;
            font-size: 14px;
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            margin-right: 20px;
        }

        #rateSlider {
            width: 200px;
            vertical-align: middle;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div style="display: inline-block;position: fixed;margin-left: 10px;margin-top: 20px;">
    <select id="voiceSelect" class="voice-select">
        <option value="">Choose the speaker</option>
    </select>
    <div>
        <label for="rateSlider">Speed:</label>
        <input id="rateSlider" type="range" min="0.5" max="2" step="0.05" value="1.00" title="语速" style="margin-bottom: 10px;">
        <span id="rateValue">1.00</span>
    </div>
    <div>
        <label for="loopInput">Loop Count:</label>
        <input id="loopInput" type="number" min="1" max="100" value="1"></input>
    </div>
    <button onclick="fill()" style="margin-top: 15px;">Fill All Inputs</button>
    <button onclick="reset()" style="margin-top: 15px;">Reset All Inputs</button>
</div>
<div id="container">
    <div id="divContent"></div>
</div>
<div id="dialog">
    <textarea id="codeInput" placeholder="Enter your code/content here..."></textarea>
    <div class="dialog-actions">
        <button onclick="generateContent()">Generate</button>
        <button onclick="closeDialog()">Close</button>
    </div>
</div>
<script>
    const dialog = document.getElementById('dialog');
    const codeInput = document.getElementById('codeInput')
    const loopInput = document.getElementById('loopInput')
    loopInput.value = localStorage.getItem('loopCount') || 1;
    loopInput.addEventListener('change', function () {
        localStorage.setItem('loopCount', this.value);
    });

    function fill() {
        document.querySelectorAll('#divContent input').forEach(input => {
            input.value = input.getAttribute('placeholder');
            input.style.color = 'orange';
        });
    }

    function reset(){
        document.querySelectorAll('#divContent input').forEach(input => {
            input.value = '';
            input.style.color = 'green';
        });
    }

    // Add these functions to the <script> section
    function openDialog() {
        dialog.style.display = 'block';
        codeInput.focus();
    }

    function closeDialog() {
        document.getElementById('dialog').style.display = 'none';
    }

    function generateContent() {
        const newCode = codeInput.value;
        const indentedCode = autoIndent(newCode);
        const processedCode = replacePlaceholders(indentedCode);
        document.getElementById('divContent').innerHTML = processedCode;
        closeDialog();
        initializeInputs(); // Re-initialize event listeners for new inputs
        codeInput.value = ""
    }

    // Add keyboard shortcut handler
    document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'o' && document.getElementById('dialog').style.display !== 'block') {
            openDialog();
            e.preventDefault();
        }
    });


    function autoIndent(code) {
        const lines = code.split('\n');
        let indentLevel = 0;
        const result = [];

        for (const line of lines) {
            const trimmedLine = line.trimStart();
            const numClose = (trimmedLine.match(/}/g) || []).length;
            const numOpen = (trimmedLine.match(/{/g) || []).length;

            const currentIndent = Math.max(indentLevel - numClose, 0) * 4;
            result.push(' '.repeat(currentIndent) + trimmedLine);

            indentLevel = Math.max(indentLevel - numClose + numOpen, 0);
        }

        return result.join('\n');
    }

    function replacePlaceholders(code) {
        return code.replace(/\*\*([^\*]+)\*\*/g, (match, p1) => {
            return `<input placeholder="${p1}" data-char-index="0">`; // 移除 p1.trim()
        });
    }

    function initializeInputs() {
        const inputs = document.querySelectorAll('#divContent input');
        inputs.forEach(input => {
            input.style.cursor = 'pointer'
            input.addEventListener('input', function () {
                const userInput = this.value; // 移除 trim()
                const placeholder = this.getAttribute('placeholder'); // 移除 trim()

                if (userInput === placeholder) {
                    this.style.color = 'orange';
                } else if (placeholder.startsWith(userInput) && userInput !== '') {
                    this.style.color = 'green';
                } else {
                    this.style.color = 'red';
                }

                // 更新字符索引
                if (placeholder.startsWith(userInput)) {
                    this.dataset.charIndex = userInput.length;
                } else {
                    this.dataset.charIndex = '0';
                }

            });

            // Add these event listeners inside the inputs.forEach loop
            input.addEventListener('mousedown', function (e) {
                this.longPressTimer = setTimeout(() => {
                    const placeholder = this.getAttribute('placeholder');
                    this.value = placeholder;
                    this.dataset.charIndex = placeholder.length.toString();
                    this.style.color = 'orange';
                    this.dispatchEvent(new Event('input'));
                }, 500); // 500ms press duration
            });

            input.addEventListener('mouseup', function (e) {
                clearTimeout(this.longPressTimer);
            });

            input.addEventListener('mouseleave', function (e) {
                clearTimeout(this.longPressTimer);
            });


            input.addEventListener('click', function (e) {
                e.stopPropagation()
                const placeholder = this.getAttribute('placeholder'); // 移除 trim()
                const currentIndex = parseInt(this.dataset.charIndex || '0', 10);
                const currentValue = this.value; // 移除 trim()

                // 检查当前输入是否匹配前N个字符
                if (currentValue === placeholder.substring(0, currentIndex)) {
                    const nextIndex = currentIndex + 1;
                    if (nextIndex <= placeholder.length) {
                        this.value = placeholder.substring(0, nextIndex);
                        this.dataset.charIndex = nextIndex.toString();
                        this.dispatchEvent(new Event('input'));
                    }
                }
            });
        });

        document.querySelectorAll("p").forEach(p => {
            p.style.cursor = 'pointer'
            p.addEventListener('click', function () {
                playText(p.innerHTML, p.querySelectorAll('input'))
            })
        })

    }

    let selectedVoice = null
    let voices = []

    const defaultVoiceName = localStorage.getItem('defaultVoiceName') || 'Microsoft Brian Online (Natural) - English (United States)';

    // 加载发音人
    function loadVoices() {
        if (selectedVoice !== null) return
        voices = window.speechSynthesis.getVoices();
        const voiceSelect = document.querySelector('#voiceSelect');
        voiceSelect.innerHTML = '<option value="">选择发音人</option>'; // 清空并添加默认选项
        let defaultVoiceIndex = null;

        voices.forEach((voice, index) => {
            const option = document.createElement('option');
            option.textContent = `${voice.name} (${voice.lang})`;
            option.value = index;

            // 检查是否为默认发音人
            if (voice.name === defaultVoiceName) { //  && voice.lang === "en-US"
                defaultVoiceIndex = index;
            }

            voiceSelect.appendChild(option);
        });

        // 自动选择默认发音人
        if (defaultVoiceIndex !== null) {
            voiceSelect.value = defaultVoiceIndex;
            selectedVoice = defaultVoiceIndex;
        }
    }

    window.speechSynthesis.onvoiceschanged = loadVoices

    // 监听发音人选择
    document.querySelector('#voiceSelect').addEventListener('change', (event) => {
        // alert(event.target.value)
        selectedVoice = event.target.value ? parseInt(event.target.value, 10) : null;
        // 更新默认发音人名称
        localStorage.setItem('defaultVoiceName', voices[selectedVoice].name);
    });

    let isPlaying = false;

    function playText(htmlText, inputs) {
        if (isPlaying) {
            speechSynthesis.cancel();
        }
        isPlaying = true;

        // 使用正则表达式将 <input {动态长度字符串}> 替换为 what
        let inputIndex = 0
        while (htmlText.includes('<input')){
            htmlText = htmlText.replace(/<input (.*?)>/, inputs[inputIndex].value ? inputs[inputIndex].value : "what-");
            inputIndex += 1
        }

        if(!htmlText.includes("what-")){
            const count = loopInput.value
            htmlText = (htmlText+" ").repeat(count).trim()
        }

        const utterance = new SpeechSynthesisUtterance(htmlText);
        utterance.voice = voices[selectedVoice];
        utterance.lang = "en-US";
        utterance.rate = parseFloat(rateSlider.value);
        utterance.onend = () => isPlaying = false;
        speechSynthesis.speak(utterance);
    }

    const rateSlider = document.getElementById("rateSlider");
    const rateValue = document.getElementById("rateValue");
    const rate = localStorage.getItem("rateValue") || 1.00
    rateValue.textContent = rate;
    rateSlider.value = rate;

    rateSlider.addEventListener("input", function () {
        rateValue.textContent = Number(this.value).toFixed(2);
        localStorage.setItem("rateValue", rateValue.textContent);
    });

    document.addEventListener("keydown", (event) => {
        console.log("Keydown event:", event.code)
        switch (event.code) {
            case "Space":
                event.preventDefault()
                speechSynthesis.cancel();
                isPlaying = false;
                break;
            case "KeyV":
                event.preventDefault()
                if(event.ctrlKey){
                    console.log("V pressed")
                    // 从剪贴板获取文本
                    navigator.clipboard.readText().then(text => {
                        const indentedCode = autoIndent(text);
                        const processedCode = replacePlaceholders(indentedCode);
                        document.getElementById('divContent').innerHTML = processedCode;
                        closeDialog();
                        initializeInputs(); // Re-initialize event listeners for new inputs
                        codeInput.value = ""
                    }).catch(err => {
                        console.error('Failed to read clipboard contents: ', err);
                    });
                }
        }
    })
</script>
</body>
</html>