<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 0 10px 1px 10px;
            background: #1e1e1e;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        textarea {
            width: 100%;
            margin-bottom: 20px;
            padding: 10px;
            font-size: 14px;
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            resize: none;
            box-sizing: border-box;
            display: none;
        }

        textarea::placeholder {
            color: #888;
        }

        /*button {*/
        /*    flex: 1;*/
        /*    padding: 5px;*/
        /*    color: #fff;*/
        /*    background-color: #3a86ff;*/
        /*    border: none;*/
        /*    border-radius: 4px;*/
        /*    cursor: pointer;*/
        /*}*/

        button:hover {
            background-color: #2a6edc;
        }

        .output {
            margin-top: 20px;
        }

        .output h3 {
            margin-bottom: 10px;
            font-size: 18px;
            color: #bbbbbb;
        }

        .output h3::before {
            content: ">";
            margin-right: 5px;
            color: #3a86ff;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            margin-bottom: 10px;
            background: #292929;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
        }

        .control-section {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
            margin-bottom: 20px;
        }

        .control-section textarea {
            flex: 1;
            height: calc(3 * 40px + 3 * 10px);
            margin: 0;
            resize: none;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
        }

        button {
            font-size: 12px;
            width: 80px;
            height: 30px;
            padding: 5px 5px;
            color: #fff;
            background-color: #3a86ff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .control-buttons button:hover {
            background-color: #2a6edc;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .voice-select {
            width: 285px;
            padding: 5px;
            font-size: 12px;
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
        }

        .speed-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .speed-control input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }

        .speed-label {
            font-size: 14px;
            width: 70px;
        }

        .voice-input-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .voice-input-section input[type="text"] {
            flex: 10;
            margin: 0;
            padding: 10px;
            background-color: #2c2c2c;
            color: #fff;
        }

        .voice-input-section button {
            flex-shrink: 0;
            padding: 10px 15px;
            font-size: 14px;
            background-color: #ff5252;
            border-radius: 4px;
            border: none;
            color: #fff;
            cursor: pointer;
            width: 200px;
        }

        .voice-input-section button:hover {
            background-color: #d84545;
        }

        label {
            font-size: 12px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header-section">
        <h3 id="title" style="cursor: pointer">Speaker</h3>

        <select id="voiceSelect" class="voice-select">
            <option value="">Choose the speaker</option>
        </select>
    </div>


    <!-- 播放句子控制 -->
    <div style="display: flex">
        <div class="control-section">
            <div class="control-buttons">
                <button id="playPauseBtn" style="width: 40px">Play</button>
                <button class="record-btn">Record</button>
            </div>
            <textarea id="playSentenceInput" placeholder="Please enter an English sentence for playback..."></textarea>
            <div class="control-buttons">
                <button id="loopPauseBtn" style="width: 40px">Loop</button>
                <button class="playback-btn">Playback</button>
                <button id="stopBtn" style="display: none">Stop</button>
                <button id="updateBtn" style="display: none">Review</button>
            </div>
        </div>
        <!-- 语速设置 -->
        <div style="margin-left: 20px">
            <label for="randomVoiceCheckbox">Random Voice</label>
            <input type="checkbox" id="randomVoiceCheckbox">
            <label for="dpCheckbox">Double Play</label>
            <input type="checkbox" id="dpCheckbox">
            <div class="speed-control" style="margin-top: 5px;">
                <label for="speedRange" class="speed-label">Speed: <span id="speedValue">1.0</span></label>
                <input type="range" id="speedRange" min="0.5" max="2" step="0.1" value="1.0">
            </div>
        </div>

    </div>
</div>

<script>
    let voices = [];
    let selectedVoice = null;
    let cnVoice = null;
    let isLooping = false;
    let isPaused = false;
    let utteranceRef = null;
    let speechSpeed = localStorage.getItem('speechSpeed') || 1.0; // 默认语速

    document.getElementById("title").addEventListener('click', function () {
        stop()
    });

    // 监听快捷键
    document.addEventListener('keydown', function (event) {
        if (event.code === 'Space') {
            stop()
        }
    });

    // 默认发音人名称
    let defaultVoiceName =  "Microsoft Brian Online (Natural) - English (United States)";

    if(localStorage.getItem('defaultVoiceName') !== undefined && localStorage.getItem('defaultVoiceName') !== "undefined"){
        defaultVoiceName = localStorage.getItem('defaultVoiceName')
    }

    let voicesEn = []

    const voicesOld = [
        'Microsoft Mark - English (United States)',
        'Microsoft Zira - English (United States)',
        'Microsoft David - English (United States)'
    ]

    const cnVoiceName = "Microsoft Yunyang Online (Natural) - Chinese (Mainland)"

    // 加载发音人
    function loadVoices() {
        if (selectedVoice !== null) return
        voices = window.speechSynthesis.getVoices();
        voicesEn = voices.filter(voice => voice.lang.includes('en')
            && !voicesOld.includes(voice.name))
        const voiceSelect = document.querySelector('#voiceSelect');
        voiceSelect.innerHTML = '<option value="">选择发音人</option>'; // 清空并添加默认选项
        let defaultVoiceIndex = null;
        voices.forEach((voice, index) => {
            const option = document.createElement('option');
            option.textContent = `${voice.name} (${voice.lang})`;
            option.value = String(index);

            // 检查是否为默认发音人
            if (voice.name === defaultVoiceName) {
                defaultVoiceIndex = index;
            }
            if(voice.name === cnVoiceName){
                cnVoice = voice
            }

            voiceSelect.appendChild(option);
        });

        // 自动选择默认发音人
        if (defaultVoiceIndex !== null) {
            voiceSelect.value = defaultVoiceIndex;
            selectedVoice = defaultVoiceIndex;
        }
    }

    let useRandomVoice = localStorage.getItem("useRandomVoice") === "true"

    const cbRandomVoice = document.getElementById("randomVoiceCheckbox")
    cbRandomVoice.checked = useRandomVoice
    cbRandomVoice.addEventListener("change", () => {
        useRandomVoice = cbRandomVoice.checked
        localStorage.setItem("useRandomVoice", useRandomVoice)
    })

    let useDoublePlay = localStorage.getItem("useDoublePlay") === "true"
    const cbDoublePlay = document.getElementById("dpCheckbox")
    cbDoublePlay.checked = useDoublePlay
    cbDoublePlay.addEventListener("change", () => {
        useDoublePlay = cbDoublePlay.checked
        localStorage.setItem("useDoublePlay", useDoublePlay)
    })

    // 文本转语音朗读
    function speakText(text, loop = false, utteranceRef = null) {
        text = text.replaceAll("* ", "")
        const hasChinese = /[\u4e00-\u9fa5]/.test(text);

        if(cbDoublePlay.checked && !hasChinese){
            text = text.split(". ").map(text => `${text}. `.repeat(2)).join("")
        }

        if ('speechSynthesis' in window) {
            if (!utteranceRef) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = hasChinese? 'zh-CN' : 'en-US';
                utterance.rate = hasChinese? 1.5 :speechSpeed; // 使用当前语速
                if(hasChinese){
                    utterance.voice = cnVoice;
                } else if(useRandomVoice){
                    const randomVoice = Math.floor(Math.random() * voicesEn.length)
                    utterance.voice = voicesEn[randomVoice];
                } else if (selectedVoice) {
                    utterance.voice = voices[selectedVoice];
                }
                if (loop) {
                    utterance.onend = () => speakText(text, true, utterance);
                }
                speechSynthesis.speak(utterance);
                return utterance;
            } else {
                if (loop) {
                    utteranceRef.onend = () => speakText(text, true, utteranceRef);
                }
                utteranceRef.rate = speechSpeed; // 更新语速
                if(useRandomVoice){
                    const randomVoice = Math.floor(Math.random() * voicesEn.length)
                    utteranceRef.voice = voicesEn[randomVoice];
                }
                speechSynthesis.speak(utteranceRef);
                return utteranceRef;
            }
        } else {
            console.warn('当前浏览器不支持语音合成功能');
            return null;
        }
    }

    // 停止朗读
    function stopSpeaking() {
        if ('speechSynthesis' in window) {
            document.querySelector("textarea").style.color = "#e0e0e0"
            speechSynthesis.cancel();
        }
    }

    const contentInput = document.querySelector('#playSentenceInput')
    // 监听输入变化
    let content = ""

    function debounce(func, delay) {
        let timeoutId;
        return function (...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    }

    const words = []

    contentInput.addEventListener('click', (event) => {
        // 获取剪贴板文本
        navigator.clipboard.readText().then(text => {
            if(text.trim() === contentInput.value.trim()){
                return
            }
            contentInput.value = text
            words.push(text)
            speakText(`${contentInput.value}, `, false, null)
            document.querySelector("textarea").style.color = "#e0e0e0"
        }).catch(err => {
            console.error('Failed to read clipboard contents: ', err);
        });
        // contentInput.value = ""
        stop()
    })

    // 播放/暂停按钮
    document.querySelector('#playPauseBtn').addEventListener('click', () => {
        // 获取剪贴板文本
        navigator.clipboard.readText().then(text => {
            contentInput.value = text
            words.push(text)
            speakText(`${contentInput.value}, `, false, null)
            document.querySelector("textarea").style.color = "#e0e0e0"
        }).catch(err => {
            console.error('Failed to read clipboard contents: ', err);
        });
        // contentInput.value = ""
        stop()
    });


    // 循环/暂停按钮
    document.querySelector('#loopPauseBtn').addEventListener('click', () => {
        navigator.clipboard.readText().then(text => {
            isLooping = !isLooping;
            stopSpeaking();
            if (utteranceRef) {
                utteranceRef.onend = null; // 移除 onend 回调
                utteranceRef = null;       // 重置 utteranceRef
            }
            if (isLooping) {
                document.querySelector('#loopPauseBtn').textContent = 'Looping';
                utteranceRef = speakText(text, true, utteranceRef);
            } else {
                document.querySelector('#loopPauseBtn').textContent = 'Loop';
            }
            // contentInput.value = text
            // words.push(text)
            // speakText(`${contentInput.value}, `, false, null)
            // document.querySelector("textarea").style.color = "#e0e0e0"
        }).catch(err => {
            console.error('Failed to read clipboard contents: ', err);
        });
    });

    // 停止按钮
    document.querySelector('#stopBtn').addEventListener('click', () => {
        stop()
    });

    function stop() {
        stopSpeaking();
        isLooping = false;
        isPaused = false;
        document.querySelector('#loopPauseBtn').textContent = 'Loop';

        // 清除之前的 utteranceRef 的循环逻辑
        if (utteranceRef) {
            utteranceRef.onend = null; // 移除 onend 回调
            utteranceRef = null;       // 重置 utteranceRef
        }
    }

    // 更新按钮
    document.querySelector('#updateBtn').addEventListener('click', () => {
        // if(words.length === 0) return
        // stop()
        // const review = words.map(word => {
        //     return `${word}, `.repeat(2)
        // }).join("")
        // contentInput.value = words.join(", ")
        // speakText(review, true, null)
        navigator.clipboard.readText().then(text => {
            if(text.trim() === contentInput.value.trim()){
                return
            }
            let nextText = text.split("\n").filter(it => !it.includes("[")).join("\n")
            contentInput.value = nextText
            contentInput.value = contentInput.value.replaceAll("\n", "").replace(/\(.*?\)/g, '').replaceAll(".", ". ")
            speakText(contentInput.value, false, null)
            document.querySelector("textarea").style.color = "#e0e0e0"
        }).catch(err => {
            console.error('Failed to read clipboard contents: ', err);
        });
        // contentInput.value = ""
        stop()
    });

    // 监听语速滑块
    const speedRange = document.querySelector('#speedRange')
    const speedValue = document.querySelector('#speedValue')
    speedRange.value = speechSpeed;
    speedValue.textContent = speechSpeed;
    speedRange.addEventListener('input', (event) => {
        speechSpeed = parseFloat(event.target.value);
        localStorage.setItem('speechSpeed', speechSpeed);
        speedValue.textContent = speechSpeed;
    });

    // 监听发音人选择
    document.querySelector('#voiceSelect').addEventListener('change', (event) => {
        // 获取选中的发音人索引
        selectedVoice = event.target.value;

        // 保存选中的发音人名称到localStorage
        if (selectedVoice !== "") {
            const selectedVoiceObj = voices[selectedVoice];
            localStorage.setItem('defaultVoiceName', selectedVoiceObj.name);
        }
    });

    // 加载发音人
    window.speechSynthesis.onvoiceschanged = loadVoices;
</script>

<script>
    let mediaRecorder;
    let audioChunks = [];
    let audioStream = null;
    let isRecording = false;
    let currentAudio = null;

    const btnRecord = document.querySelector(".record-btn");
    const btnPlayback = document.querySelector(".playback-btn");

    btnRecord.addEventListener("click", async () => {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            if (isRecording) {
                // 停止录音
                mediaRecorder.stop();
                btnRecord.classList.remove("recording");
                btnRecord.textContent = "Record";
                isRecording = false;
            } else {
                // 开始录音
                try {
                    if (!audioStream) {
                        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    }
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(audioStream);

                    mediaRecorder.ondataavailable = e => {
                        audioChunks.push(e.data);
                    };

                    mediaRecorder.start();
                    btnRecord.classList.add("recording");
                    btnRecord.textContent = "Recording...";
                    isRecording = true;
                } catch (err) {
                    console.error("无法访问麦克风:", err);
                }
            }
        } else {
            alert("你的浏览器不支持 getUserMedia。");
        }
    });

    btnPlayback.addEventListener("click", () => {
        if (audioChunks.length === 0) {
            alert("请先录音！");
            return;
        }

        if (btnPlayback.textContent === "Playback") {
            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            currentAudio = audio;

            audio.addEventListener("ended", () => {
                btnPlayback.textContent = "Playback";
            });

            audio.play();
            btnPlayback.textContent = "Stop";
        } else {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            btnPlayback.textContent = "Playback";
        }
    });

    // 清理资源
    window.addEventListener("beforeunload", () => {
        if (audioStream) {
            audioStream.getTracks().forEach(track => track.stop());
        }
    });
</script>

</body>
</html>