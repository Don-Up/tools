<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>多选择题生成器</title>
    <style>
        body {
            color: #eee;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px 20px;
            background-color: #333;
        }

        h1 {
            text-align: center;
        }

        /* 外层 Flex 布局实现左右分栏 */
        .container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        /* 左侧输入区域 */
        .input-panel {
            flex: 1 1 300px;
            max-width: 600px;
            background-color: #444;
            padding: 20px;
            border-radius: 5px;
            height: 72vh;
            max-height: 72vh; /* Set a max-height if needed */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .input-panel textarea {
            width: 96%;
            height: 87%;
            margin-bottom: 10px;
            font-size: 14px;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #888;
            //background-color: #333;
            background: rgba(50, 50, 50, 0.5);
            color: #eee;
        }

        .input-panel button {
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background-color: #0066cc;
            color: #fff;
        }

        /* 右侧展示区域 */
        .output-panel {
            flex: 1;
            background-color: #444;
            padding: 20px;
            border-radius: 5px;
            min-height: 300px;
        }

        #front-content {
            overflow-y: auto; /* Enable vertical scrolling */
            max-height: 70vh;
        }

        /* Webkit-based browsers (Chrome, Safari, Edge) */
        select::-webkit-scrollbar, pre::-webkit-scrollbar, #front-content::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
        }

        select::-webkit-scrollbar-track, pre::-webkit-scrollbar-track, #front-content::-webkit-scrollbar-track {
            background: #555; /* Color of the scrollbar track */
        }

        select::-webkit-scrollbar-thumb, pre::-webkit-scrollbar-thumb, #front-content::-webkit-scrollbar-thumb {
            background: #888; /* Color of the scrollbar thumb */
            border-radius: 4px; /* Rounded corners for the scrollbar thumb */
        }

        select::-webkit-scrollbar-thumb:hover, pre::-webkit-scrollbar-thumb:hover, #front-content::-webkit-scrollbar-thumb:hover {
            background: #aaa; /* Color of the scrollbar thumb on hover */
        }

        /* Firefox */
        select, pre, #front-content {
            scrollbar-width: thin; /* Thickness of the scrollbar */
            scrollbar-color: #888 #555; /* Color of the scrollbar thumb and track */
        }

        .voice-select {
            width: 450px;
            padding: 5px;
            font-size: 14px;
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            margin-right: 20px;
        }

        .hide-control {
            margin-left: 20px;
        }

        .multiple-choice-component {
            //border: 2px solid #444;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 0 15px 10px;
            //background-color: #222;
            background: rgba(50, 50, 50, 0.5);
            backdrop-filter: blur(7px);
            color: #fff;
            text-align: left;
            margin-bottom: 15px;
            margin-right: 5px;
        }

        .multiple-choice-component p.questionText {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            display: inline-block;
        }

        .radio-label {
            display: block;
            margin: 5px 0;
            font-size: 15px;
            cursor: pointer;
            padding-left: 10px;
        }

        .btnPlayQC,
        .btnPlay,
        .btnCopy,
        .btnOption,
        .btnHide,
        .btnExplain
         {
            display: inline-block;
            margin-left: 8px;
            padding: 4px 8px; /* Reduced padding for a smaller button */
            background-color: #007BFF; /* Primary blue color */
            color: #fff;
            border-radius: 4px; /* Slightly reduced border-radius */
            font-size: 12px; /* Smaller font size */
            cursor: pointer;
            border: none; /* Remove default border */
            transition: background-color 0.3s ease; /* Smooth transition */
            /* 禁止获取焦点 */
            outline: none;
        }


        .btnCopy:hover,
        .btnHide:hover {
            background-color: #0056b3; /* Darker blue on hover */
        }


        /* 隐藏原生单选按钮 */
        input[type="radio"] {
            display: none;
        }

        .correct {
            background-color: #28a745;
            color: #eee;
        }

        .incorrect {
            background-color: #dc3545;
            color: #eee;
        }

        .popup {
            position: absolute;
            width: 600px;
            height: 500px;
            top: calc((100% - 500px) / 2);
            right: 10px;
            background-color: #262a2b;
            border-radius: 10px;
            visibility: hidden;
        }

        .close {
            padding-left: 10px;
            padding-right: 10px;
            font-size: 40px;
            right: 0;
            position: absolute;
            top: 0;
        }
    </style>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
<div id="header">
    <h1>Multiple Choice Question Generator</h1>
    <div style="display: flex;align-items: center">
        <select id="voiceSelect" class="voice-select">
            <option value="">Choose the speaker</option>
        </select>
        <!-- 语速设置 -->
        <div class="speed-control">
            <label for="speedRange" class="speed-label">Speed: <span id="speedValue">1.0</span></label>
            <input type="range" id="speedRange" min="0.5" max="1.5" step="0.1" value="1.0">
        </div>
        <!-- 默认是否隐藏开关   -->
        <div class="hide-control">
            <label for="hideCheckbox">Hide</label>
            <input type="checkbox" id="hideCheckbox" checked>
        </div>
        <div class="hide-control">
            <label for="hideAnswersCheckbox">Only Answers</label>
            <input type="checkbox" id="hideAnswersCheckbox">
        </div>
        <!--    <div class="hide-control">-->
        <!--        <label for="listenCheckbox">Listen</label>-->
        <!--        <input type="checkbox" id="listenCheckbox">-->
        <!--    </div>-->
        <!--  连读次数输入框  -->
        <div class="hide-control">
            <label for="loopCount">Loop:</label>
            <input type="number" id="loopCount" min="0" max="10" value="2"></input>
        </div>
        <div class="hide-control">
            <label for="ctrlCheckbox">Ctrl</label>
            <input type="checkbox" id="ctrlCheckbox">
        </div>
        <button id="fullScreen" class="btnCopy">Full</button>
        <div class="hide-control">
            <label for="countdown">CD(m):</label>
            <input type="number" id="countdown" min="0" max="40" value="0"></input>
            <button id="startCountdown" class="btnCopy">Start</button>
        </div>
        <!--        选择图片-->
        <input type="file" id="imageInput" accept="image/*" style="display: none;">
        <button id="selectImage" class="btnCopy">Select Image</button>
        <!--        单选框: Prioritize Read: 1. Question. 2. Q & choices-->
        <div class="hide-control">
            <label for="priorityRead">Read:</label>
            <select id="priorityRead">
                <option value="1">Question</option>
                <option value="2">Q & choices</option>
            </select>
        </div>
    </div>
</div>
<div class="container">
    <!-- 左侧输入区域 -->
    <div class="input-panel">
        <div style="height: 20vh">
            <textarea id="choiceInput" placeholder="1. 按住ctrl键, 点击选项后, 播放n次.
2. 按住alt键, 取消点击播放.
3. 按下1234键, 试听选项.
4. 按下space键, 立即停止播放.
                      "></textarea>
            <br>
            <div>
                <button id="btnConfirm">确认</button>
                <button id="btnRead" style="margin-left: 5px;">朗读</button>
                <input type="number" id="countInput" min="1" max="100" value="10" style="width: 50px;margin-left: 5px;">
                <span>次</span>
            </div>
            <!--            <button id="btnInsertCode">插入代码</button>-->
        </div>
        <pre id="codePre" style="flex: 1;overflow-y: auto;margin-top: 60px;">
            <code id="codeOutput"></code>
        </pre>
    </div>

    <!-- 右侧展示区域 -->
    <div class="output-panel">
        <div id="front-content">
            <div id="choiceField"></div>
        </div>
    </div>
</div>
<img id="imgBg" src="img/bg.png" alt="background"
     style="visibility: hidden;object-fit: cover;position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;">

<!--弹窗-->
<div id="popup" class="popup">
    <pre id="codePre1" style="overflow-y: auto;height: 480px;padding: 0 20px">
            <code id="codeOutput1" style="padding: 0!important;margin: 0!important;"></code>
        </pre>
    <!--    <span class="close" id="closePopup">&times;</span>-->
</div>
<script>
    let immersion = false
    let voices = [];
    let selectedVoice = null;
    let isLooping = false;
    let isPaused = false;
    let utteranceRef = null;
    let speechSpeed = 1.0; // 默认语速
    const inputCount = document.getElementById('loopCount');
    const code = document.getElementById("codeOutput")
    const code1 = document.getElementById("codeOutput1")
    const btnRead = document.getElementById('btnRead')
    const countInput = document.getElementById('countInput')
    let currentText = [];

    const hideAnswersCheckbox = document.getElementById('hideAnswersCheckbox');
    hideAnswersCheckbox.checked = localStorage.getItem('hideAnswersCheckbox') === 'true';
    hideAnswersCheckbox.addEventListener('change', function () {
        localStorage.setItem('hideAnswersCheckbox', hideAnswersCheckbox.checked);
    });

    const imgBg = document.getElementById("imgBg");

    let dbChoices;

    function initDBChoices() {
        const request = indexedDB.open('choicesDB', 1);

        request.onupgradeneeded = function (event) {
            dbChoices = event.target.result;
            const objectStore = dbChoices.createObjectStore('images', { keyPath: 'id' });
            objectStore.createIndex('id', 'id', { unique: true });
        };

        request.onsuccess = function (event) {
            dbChoices = event.target.result;
            loadImageFromDBChoices();
        };

        request.onerror = function (event) {
            console.error('Database error: ' + event.target.errorCode);
        };
    }

    initDBChoices();

    // Load image from IndexedDB if it exists
    function loadImageFromDBChoices() {
        if (!dbChoices) {
            console.error('Database not initialized');
            return;
        }

        const transaction = dbChoices.transaction(['images'], 'readonly');
        const objectStore = transaction.objectStore('images');
        const request = objectStore.get('backgroundImage');

        request.onsuccess = function (event) {
            const imageData = event.target.result;
            if (imageData) {
                imgBg.src = imageData.data;
                if (immersion) {
                    imgBg.style.visibility = "visible";
                }
            }
        };

        request.onerror = function (event) {
            console.error('Error loading image: ' + event.target.errorCode);
        };
    }

    document.getElementById("imageInput").addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const base64Image = e.target.result;
                imgBg.src = base64Image;
                if (immersion) {
                    imgBg.style.visibility = "visible";
                }

                const transaction = dbChoices.transaction(['images'], 'readwrite');
                const objectStore = transaction.objectStore('images');
                const request = objectStore.put({ id: 'backgroundImage', data: base64Image });

                request.onsuccess = function () {
                    console.log('Image saved successfully');
                };

                request.onerror = function (event) {
                    console.error('Error saving image: ' + event.target.errorCode);
                };
            };
            reader.readAsDataURL(file);
        } else {
            imgBg.style.visibility = "hidden";
        }
    });

    document.getElementById("selectImage").addEventListener("click", function () {
        document.getElementById("imageInput").click();
    });

    let timerId = null;
    const countdown = document.getElementById("countdown")
    countdown.value = localStorage.getItem('countdown') || 0;
    countdown.addEventListener('input', function () {
        localStorage.setItem('countdown', countdown.value);
    });
    const startCountdown = document.getElementById("startCountdown")
    startCountdown.addEventListener('click', function () {
        if (countdown.value === "0") {
            alert('Please input countdown time')
            return
        }
        if (timerId === null && startCountdown.textContent === "Start") {
            startCountdown.textContent = "stop"
            timerId = setTimeout(() => {
                alert('Time out')
                startCountdown.textContent = "Start"
                timerId = null
            }, countdown.value * 60 * 1000)
        } else if (timerId !== null) {
            clearTimeout(timerId)
            startCountdown.textContent = "Start"
            timerId = null
        }
    })


    countInput.value = localStorage.getItem('loopCount1') || 10;
    countInput.addEventListener('input', function () {
        localStorage.setItem('loopCount1', countInput.value);
    });
    btnRead.addEventListener('click', function () {
        const text = document.getElementById('choiceInput').value
        currentText = text || currentText
        if (currentText) {
            speakText(`${currentText}, `.repeat(countInput.value))
            document.getElementById('choiceInput').value = ""
        }
    });

    inputCount.value = localStorage.getItem('loopCount') || 2;
    inputCount.addEventListener('input', function () {
        localStorage.setItem('loopCount', inputCount.value);
    });

    // 默认发音人名称, 优先从localstorage中获取, 获取不到使用Microsoft Brian Online (Natural) - English (United States)
    const defaultVoiceName = localStorage.getItem('defaultVoiceName') || 'Microsoft Brian Online (Natural) - English (United States)';

    const btnFullScreen = document.getElementById('fullScreen')
    btnFullScreen.addEventListener('click', function () {
        if (btnFullScreen.textContent === 'Full') {
            document.documentElement.requestFullscreen();
            btnFullScreen.textContent = 'Exit'
        } else {
            document.exitFullscreen();
            btnFullScreen.textContent = 'Full'
        }
    })

    let currentIndex = 0
    const inputPanel = document.querySelector(".input-panel")
    const outputPanel = document.querySelector(".output-panel")
    const choiceField = document.getElementById('choiceField')
    const frontContent = document.getElementById("front-content")
    const codePre = document.getElementById("codePre")
    let codePreHeight = 0
    const popup = document.querySelector(".popup")

    function preQuestion(event) {
        if (immersion) {
            event.preventDefault()
            if (currentIndex > 0) {
                const children = choiceField.children
                // const questionText = children[currentIndex].querySelector(".questionText")
                // const answers = children[currentIndex].querySelectorAll(".answer")
                // questionText.style.visibility = 'hidden';
                // answers.forEach(answer => {
                //     answer.style.visibility = 'hidden'
                // })
                currentIndex--
                if(children[currentIndex].querySelector(".questionText").textContent.includes("snippet") && popup.style.visibility !== "visible"){
                    popup.style.visibility = "visible"
                } else if(popup.style.visibility === "visible") {
                    popup.style.visibility = "hidden"
                }
                localStorage.setItem('currentIndex', currentIndex)
                children[currentIndex].style.visibility = "visible"
                children[currentIndex].style.scale = "1.4"
                if (priorityRead.value === 1) {
                    children[currentIndex].querySelector(".btnPlay").click() //111
                } else {
                    children[currentIndex].querySelector(".btnPlayQC").click()
                }
                children[currentIndex].scrollIntoView({behavior: "smooth", block: "center"})
                for (let i = 0; i < children.length; i++) {
                    if (i !== currentIndex) {
                        children[i].style.visibility = "hidden"
                    }
                }
            }
        }
    }

    const priorityRead = document.getElementById('priorityRead')
    priorityRead.value = localStorage.getItem('priorityRead') || "1"
    priorityRead.addEventListener('input', function () {
        localStorage.setItem('priorityRead', priorityRead.value);
    });

    function nextQuestion(event) {
        if (immersion) {
            event.preventDefault()
            if (currentIndex < choiceField.children.length - 1) {
                const children = choiceField.children
                // const questionText = children[currentIndex].querySelector(".questionText")
                // const answers = children[currentIndex].querySelectorAll(".answer")
                // questionText.style.visibility = 'hidden';
                // answers.forEach(answer => {
                //     answer.style.visibility = 'hidden'
                // })
                currentIndex++
                if(children[currentIndex].querySelector(".questionText").textContent.includes("snippet") && popup.style.visibility !== "visible"){
                    popup.style.visibility = "visible"
                } else if(popup.style.visibility === "visible") {
                    popup.style.visibility = "hidden"
                }
                localStorage.setItem('currentIndex', currentIndex)
                children[currentIndex].style.visibility = "visible"
                children[currentIndex].style.scale = "1.4"
                if (priorityRead.value === "1") {
                    children[currentIndex].querySelector(".btnPlay").click() //111
                } else {
                    children[currentIndex].querySelector(".btnPlayQC").click()
                }
                children[currentIndex].scrollIntoView({behavior: "smooth", block: "center"})
                for (let i = 0; i < children.length; i++) {
                    if (i !== currentIndex) {
                        children[i].style.visibility = "hidden"
                    }
                }
            }
        }
    }

    document.addEventListener("keydown", function (event) {
        if (event.altKey && event.code === "KeyV") {
            // 将剪贴板中的图片设置为背景图
            navigator.clipboard.read().then(async (clipboardItems) => {
                if (clipboardItems.length > 0) {
                    const blob = await clipboardItems[0].getType("image/png");
                    const url = URL.createObjectURL(blob);
                    imgBg.src = url;
                }
            });
        }
    });

    let enterIndex = 0

    function goToImmersion() {
        imgBg.style.visibility = 'visible'
        codePreHeight = codePre.clientHeight
        document.body.style.background = "transparent"
        immersion = true
        inputPanel.style.display = 'none'
        // inputPanel.style.height = '70vh'
        document.getElementById("header").style.display = 'none'
        outputPanel.style.height = '90vh'
        outputPanel.style.padding = '0'
        outputPanel.style.backgroundColor = 'rgba(0, 0, 0, 0)'

        frontContent.style.maxHeight = '90vh'
        // 隐藏滚动
        frontContent.style.overflowY = 'hidden'
        choiceField.style.padding = "0 20%"
        const children = choiceField.children
        enterIndex = currentIndex
        children[currentIndex].style.scale = "1.4"
        children[currentIndex].style.marginTop = "50%"
        children[children.length - 1].style.marginBottom = "50%"
        children[currentIndex].scrollIntoView({behavior: "smooth", block: "center"})
        for (let i = 0; i < children.length; i++) {
            if (i !== currentIndex) {
                children[i].style.visibility = "hidden"
            }
        }
    }

    function exitImmersion() {
        imgBg.style.visibility = 'hidden'
        document.body.style.background = "#333"
        immersion = false
        inputPanel.style.display = 'block'
        document.getElementById("header").style.display = 'block'
        // flex: 1;overflow-y: auto;margin-top: 60px;
        codePre.style.flex = '1'
        codePre.style.maxHeight = codePreHeight + "px"
        codePre.style.overflowY = 'auto'
        frontContent.style.overflowY = 'auto'
        outputPanel.style.height = '70vh'
        outputPanel.style.padding = '20px'
        outputPanel.style.backgroundColor = '#444'
        frontContent.style.maxHeight = '70vh'
        choiceField.style.padding = "0"
        const children = choiceField.children
        children[enterIndex].style.marginTop = "0%"
        children[children.length - 1].style.marginBottom = "0%"
        children[currentIndex].scrollIntoView({behavior: "smooth", block: "start"})
        for (let i = 0; i < children.length; i++) {
            children[i].style.scale = "1"
            if (i !== currentIndex) {
                children[i].style.visibility = "visible"
            }
        }
    }

    let isRecording = false
    let audioChunks = [];
    let mediaRecorder;
    let currentAudio = null;
    let audioStream; // Store the stream globally
    let isPlayback = false;

    async function record() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            if (isRecording) {
                // Stop recording
                mediaRecorder.stop();
                isRecording = false;

            } else {
                // Start recording
                if (!audioStream) {
                    try {
                        audioStream = await navigator.mediaDevices.getUserMedia({audio: true});
                    } catch (err) {
                        console.error("Error accessing media devices.", err);
                        return;
                    }
                }

                const children = choiceField.children
                const questionText = children[currentIndex].querySelector(".questionText")
                const answers = children[currentIndex].querySelectorAll(".answer")
                questionText.style.color = "#d93a49"
                answers.forEach(answer => {
                    answer.style.visibility = 'hidden'
                })

                mediaRecorder = new MediaRecorder(audioStream);

                mediaRecorder.ondataavailable = event => {
                    audioChunks = []
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    questionText.style.color = "white"
                    answers.forEach(answer => {
                        answer.style.visibility = 'visible'
                    })
                };

                mediaRecorder.start();
                isRecording = true;
                // recordBtn.textContent = "Recording";
                // if (currentP && hideTextCheckbox.checked) currentP.style.visibility = "hidden";
            }
        } else {
            console.error("getUserMedia not supported on your browser.");
        }
    }

    function playback() {
        if (!isPlayback) {
            isPlayback = true;
            const audioBlob = new Blob(audioChunks, {type: 'audio/wav'});
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            // 监听播放结束
            audio.addEventListener('ended', () => {
                isPlayback = false;
            });
            currentAudio = audio;
            audio.play();
        } else {
            // 停止播放录音
            currentAudio.pause();
            isPlayback = false;
        }
    }

    // 监听space键
    document.addEventListener('keydown', function (event) {
        // console.log(event.code, event.key)
        switch (event.code) {
            case "KeyR":
                event.preventDefault()
                record()
                break
            case "KeyT":
                event.preventDefault()
                playback()
                break
            case 'KeyY':
                // 获取当前选中的文本
                const text = window.getSelection()
                currentText = text || currentText
                if (currentText) {
                    speakText(`${currentText}, `.repeat(countInput.value))
                }
                break
            case 'KeyV':
                event.preventDefault()
                if (event.ctrlKey) {
                    // 获取剪贴板中的文本
                    navigator.clipboard.readText().then(text => {
                        // 将文本内容替换到input中
                        currentIndex = 0
                        document.getElementById('choiceInput').value = text
                        document.getElementById('btnConfirm').click()
                        if (immersion) {
                            exitImmersion()
                            goToImmersion()
                        }
                        document.getElementById("codePre1").scrollTop = 0
                    }).catch(error => {
                        console.error('Failed to read clipboard:', error)
                    })
                }
                break
            case 'KeyQ':
                event.preventDefault()
                choiceField.children[currentIndex].querySelector(".btnHide").click()
                break
            case 'KeyO':
            case 'KeyD':
                event.preventDefault()
                choiceField.children[currentIndex].querySelector(".btnOption").click()
                break
            case 'KeyP':
            case 'KeyA':
                event.preventDefault()
                choiceField.children[currentIndex].querySelector(".btnPlay").click()
                break
            case 'KeyX':
                event.preventDefault()
                choiceField.children[currentIndex].querySelector(".btnExplain").click()
                break
            case 'KeyE':
                // 显示自定义弹窗
                const style = document.querySelector(".popup").style
                const visibility = style.visibility
                style.visibility = visibility === "visible" ? "hidden" : "visible"
                break
            case 'ArrowUp':
            case 'KeyW':
                preQuestion(event)
                break
            case 'ArrowDown':
            case 'KeyS':
                nextQuestion(event)
                break
            case 'KeyF':
                if (!immersion) {
                    goToImmersion()
                } else {
                    exitImmersion()
                }
                break;
            case 'Space':
                event.preventDefault()
                window.speechSynthesis.cancel()
                break;
            case 'Digit1':
                event.preventDefault()
                if (currentText.length > 0) {
                    if (event.altKey) {
                        currentContainer[0].click()
                    } else {
                        stop()
                        speakText(event.ctrlKey ? `${currentText[0]} `.repeat(parseInt(inputCount.value)) : currentText[0])
                    }
                }
                break
            case 'Digit2':
                event.preventDefault()
                if (currentText.length > 1) {
                    if (event.altKey) {
                        currentContainer[1].click()
                    } else {
                        stop()
                        speakText(event.ctrlKey ? `${currentText[1]} `.repeat(parseInt(inputCount.value)) : currentText[1])
                    }
                }
                break
            case 'Digit3':
                event.preventDefault()
                if (currentText.length > 2) {
                    if (event.altKey) {
                        currentContainer[2].click()
                    } else {
                        stop()
                        speakText(event.ctrlKey ? `${currentText[2]} `.repeat(parseInt(inputCount.value)) : currentText[2])
                    }
                }
                break
            case 'Digit4':
                event.preventDefault()
                if (currentText.length > 3) {
                    if (event.altKey) {
                        currentContainer[3].click()
                    } else {
                        stop()
                        speakText(event.ctrlKey ? `${currentText[3]} `.repeat(parseInt(inputCount.value)) : currentText[3])
                    }
                }
                break
        }
    });

    // 加载发音人
    function loadVoices() {
        if (selectedVoice !== null) return
        voices = window.speechSynthesis.getVoices();
        const voiceSelect = document.querySelector('#voiceSelect');
        voiceSelect.innerHTML = '<option value="">选择发音人</option>'; // 清空并添加默认选项
        let defaultVoiceIndex = null;

        voices.forEach((voice, index) => {
            const option = document.createElement('option');
            option.textContent = `${voice.name} (${voice.lang})`;
            option.value = index;

            // 检查是否为默认发音人
            if (voice.name === defaultVoiceName) { //  && voice.lang === "en-US"
                defaultVoiceIndex = index;
            }

            voiceSelect.appendChild(option);
        });

        // 自动选择默认发音人
        if (defaultVoiceIndex !== null) {
            voiceSelect.value = defaultVoiceIndex;
            selectedVoice = defaultVoiceIndex;
        }
    }

    // 文本转语音朗读
    function speakText(text, loop = false, utteranceRef = null) {
        if ('speechSynthesis' in window) {
            if (!utteranceRef) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = speechSpeed; // 使用当前语速
                if (selectedVoice) {
                    utterance.voice = voices[selectedVoice];
                }
                if (loop) {
                    utterance.onend = () => speakText(text, true, utterance);
                }
                speechSynthesis.speak(utterance);
                return utterance;
            } else {
                if (loop) {
                    utteranceRef.onend = () => speakText(text, true, utteranceRef);
                }
                utteranceRef.rate = speechSpeed; // 更新语速
                speechSynthesis.speak(utteranceRef);
                return utteranceRef;
            }
        } else {
            console.warn('当前浏览器不支持语音合成功能');
            return null;
        }
    }

    // 停止朗读
    function stopSpeaking() {
        if ('speechSynthesis' in window) {
            speechSynthesis.cancel();
        }
    }

    function stop() {
        stopSpeaking();
        isLooping = false;
        isPaused = false;
        // 清除之前的 utteranceRef 的循环逻辑
        if (utteranceRef) {
            utteranceRef.onend = null; // 移除 onend 回调
            utteranceRef = null;       // 重置 utteranceRef
        }
    }

    const speedRange = document.querySelector('#speedRange')
    const speedSpan = document.querySelector('#speedValue')
    // 从localstorage中获取语速, 获取不到使用默认值1.0
    speechSpeed = parseFloat(localStorage.getItem('speechSpeed')) || 1.0;
    speedSpan.textContent = speechSpeed.toFixed(1);
    speedRange.value = speechSpeed;
    // 监听语速滑块
    speedRange.addEventListener('input', (event) => {
        speechSpeed = parseFloat(event.target.value);
        speedSpan.textContent = speechSpeed.toFixed(1);
        localStorage.setItem('speechSpeed', speechSpeed.toString());
    });

    // 监听发音人选择
    document.querySelector('#voiceSelect').addEventListener('change', (event) => {
        // alert(event.target.value)
        selectedVoice = event.target.value ? parseInt(event.target.value, 10) : null;
        // 更新默认发音人名称
        localStorage.setItem('defaultVoiceName', voices[selectedVoice].name);
    });

    // 加载发音人
    window.speechSynthesis.onvoiceschanged = loadVoices;


    // 辅助函数：复制文本到剪贴板
    function fallbackCopyText(text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
    }

    // 单选按钮点击处理函数
    function handleChoice(selectedRadio, answer) {
        const component = selectedRadio.closest('.multiple-choice-component');
        const correctAnswer = component.dataset.correctAnswer;
        // 禁用当前题目中所有选项
        const radios = component.querySelectorAll('input[type="radio"]');
        radios.forEach(radio => {
            radio.disabled = true;
        });
        // 添加样式标记选择结果
        if (answer === correctAnswer) {
            selectedRadio.parentNode.classList.add('correct');
        } else {
            selectedRadio.parentNode.classList.add('incorrect');
            // 标记正确答案
            const correctRadio = Array.from(radios).find(radio =>
                radio.nextSibling.textContent.trim().startsWith(correctAnswer + '.')
            );
            if (correctRadio) {
                correctRadio.parentNode.classList.add('correct');
            }
        }
    }

    // 解析输入文本，返回题目块数组
    function parseQuestionBlocks(rawText) {
        let textList = rawText.split('\n')
        const separateIndex = textList.findIndex(line => line.trim() === "------")
        if (separateIndex !== -1) {
            const codeSnippet = textList.slice(separateIndex + 2)
            code.textContent = codeSnippet.join('\n');
            code.className = `language-tsx`;
            code1.textContent = codeSnippet.join('\n');
            code1.className = `language-tsx`;
            hljs.highlightElement(code);
            hljs.highlightElement(code1);
            textList = textList.slice(0, separateIndex)
        }

        const lines = textList.map(line => line.trim()).filter(line => line !== '');
        const blocks = [];
        let i = 0;
        while (i < lines.length) {
            // 第一行为题目文本
            const questionText = lines[i++];
            if (questionText.startsWith("#")) {
                continue
            }
            const options = [];
            // 收集选项：直到遇到以"number-"为开始的行（表示正确答案）
            while (i < lines.length && !/^\d+$/.test(lines[i]) && !/^\d+:/.test(lines[i])) {
                options.push(lines[i++]);
            }
            if (i < lines.length && (/^\d+$/.test(lines[i]) || /^\d+:/.test(lines[i]))) {
                if(/^\d+:/.test(lines[i])){
                    const correctAnswer = lines[i][0];
                    const explanation = lines[i].slice(2).trim()
                    i++
                    blocks.push({questionText, options, correctAnswer, explanation});
                } else {
                    const correctAnswer = lines[i++];
                    blocks.push({questionText, options, correctAnswer});
                }
            } else {
                // 格式错误：未找到答案行，退出
                break;
            }
        }
        return blocks;
    }

    const hideCheckbox = document.querySelector('#hideCheckbox');
    hideCheckbox.checked = localStorage.getItem('hideCheckbox') === 'true';

    hideCheckbox.addEventListener('change', (event) => {
        localStorage.setItem('hideCheckbox', event.target.checked);
        document.querySelectorAll('.btnHide').forEach(component => {
            component.click()
        });
    })

    const ctrlCheckBox = document.getElementById("ctrlCheckbox")
    ctrlCheckBox.checked = localStorage.getItem('ctrlCheckbox') === 'true';
    ctrlCheckBox.addEventListener('change', (event) => {
        localStorage.setItem('ctrlCheckbox', event.target.checked);
    })

    let currentContainer = []

    // 根据题目块生成选择题组件，并放入页面中
    function buildMultipleChoiceComponents(rawText) {
        const blocks = parseQuestionBlocks(rawText);
        const choiceField = document.getElementById('choiceField');
        choiceField.innerHTML = '';  // 清空之前的内容

        blocks.forEach((block, blockIndex) => {
            // 创建组件外层容器
            const container = document.createElement('div');

            // 使用正则解析选项（格式： "数字. 选项内容" ）
            const optionRegex = /^(\d+)\.\s*(.+)$/;
            let optionObjects = block.options.map(optionText => {
                const match = optionText.match(optionRegex);
                if (!match) return null;
                const tail = (match[2].trim().endsWith(".") || match[2].trim().endsWith("。")) ? " " : ". "
                return {
                    originalNumber: match[1], // 原始选项编号
                    answerContent: match[2].trim() + tail
                };
            }).filter(item => item !== null);

            if (optionObjects.length === 0) return; // 无有效选项则跳过

            // 随机打乱选项顺序（Fisher-Yates 洗牌算法）
            if(block.options.length > 2 ){
                for (let j = optionObjects.length - 1; j > 0; j--) {
                    const k = Math.floor(Math.random() * (j + 1));
                    [optionObjects[j], optionObjects[k]] = [optionObjects[k], optionObjects[j]];
                }
            }

            let optionContent = ""
            for (let i = 0; i < optionObjects.length; i++) {
                const option = optionObjects[i];
                optionContent += (i + 1) + ". " + option.answerContent;
            }
            const readText = block.questionText + " " + optionContent


            container.className = 'multiple-choice-component';
            // data-correct-answer 稍后设置
            container.setAttribute('data-correct-answer', '');

            // 题目文本
            const p = document.createElement('p');
            p.className = 'questionText';
            // Determine if block.questionText starts with a number
            if (/^\d+/.test(block.questionText)) {
                p.textContent = block.questionText;
            } else {
                p.textContent = (blockIndex + 1) + ". " + block.questionText;
            }
            container.appendChild(p);

            container.append(document.createElement("br"))

            const divQ = document.createElement('div')
            divQ.className = 'btnCopy'
            divQ.textContent = "Q" + (blockIndex + 1)+"/"+blocks.length
            divQ.addEventListener('click', () => {
                currentIndex = blockIndex
            })
            container.appendChild(divQ)

            // 复制按钮（使用 class 以免重复 id）
            const copyButton = document.createElement('button');
            copyButton.className = 'btnCopy';
            copyButton.textContent = 'copy';
            container.appendChild(copyButton);

            // 播放按钮
            const playButton = document.createElement('button');
            playButton.className = 'btnPlayQC';
            playButton.textContent = 'play';
            container.appendChild(playButton);


            const playButton1 = document.createElement('button');
            playButton1.className = 'btnPlay';
            playButton1.textContent = 'play q';
            container.appendChild(playButton1);


            const playButton2 = document.createElement('button');
            playButton2.className = 'btnOption';
            playButton2.textContent = 'play op';
            container.appendChild(playButton2);
            playButton2.addEventListener('click', () => {
                play(optionContent)
            });

            function play(textForReading) {
                if (event.altKey) return
                stop()
                const text = textForReading.trim().replace(/[()#*<>`•__]/g, '').replace(/e\.g\.,/gi, 'such-as').replace(/\//g, ' '); // .replace(/^\d+\.\s*/gm, '')
                if (!text) {
                    alert('Please enter the English sentence to be played');
                    return;
                }

                if (isPaused) {
                    isPaused = false;
                    speechSynthesis.resume();
                } else if (speechSynthesis.speaking) {
                    isPaused = true;
                    speechSynthesis.pause();
                } else {
                    utteranceRef = speakText(text, false, utteranceRef);
                }
            }

            // 循环按钮
            const loopButton = document.createElement('button');
            loopButton.className = 'btnCopy';
            loopButton.textContent = 'loop';
            container.appendChild(loopButton);
            loopButton.addEventListener('click', () => {
                // 播放题目文本
                const text = readText.replace(/[()#*<>`•]/g, '').replace(/e\.g\.,/gi, 'such-as').replace(/\//g, ' '); //.replace(/^\d+\.\s*/gm, '')
                if (!text) {
                    alert('Please enter the English sentence to be played');
                    return;
                }
                isLooping = !isLooping;
                stopSpeaking();
                if (isLooping) {
                    loopButton.textContent = 'Looping';
                    utteranceRef = speakText(text, true, utteranceRef);
                } else {
                    loopButton.textContent = 'Loop';
                }
            });

            // 停止按钮
            const stopButton = document.createElement('button');
            stopButton.className = 'btnCopy';
            stopButton.textContent = 'stop';
            container.appendChild(stopButton);
            stopButton.addEventListener('click', () => {
                // 停止播放
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
            });

            // 隐藏按钮
            const hideButton = document.createElement('button');
            hideButton.className = 'btnHide';
            hideButton.textContent = 'hide';
            container.appendChild(hideButton);
            const questionText = container.querySelector(".questionText")
            hideButton.addEventListener('click', () => {
                const answers = container.querySelectorAll(".answer")
                // 隐藏组件
                if (answers[0].style.visibility === 'hidden') {
                    if(!hideAnswersCheckbox.checked){
                        questionText.style.visibility = 'visible';
                    }
                    answers.forEach(answer => {
                        answer.style.visibility = 'visible'
                    })
                    hideButton.textContent = 'hide'
                } else {
                    answers.forEach(answer => {
                        answer.style.visibility = 'hidden'
                    })
                    hideButton.textContent = 'show'
                }
            });

            const explainButton = document.createElement('button');
            explainButton.className = 'btnExplain';
            explainButton.textContent = 'explain';
            explainButton.addEventListener('click', () => {
                play(block.explanation || "no explanation")
                alert(block.explanation || "no explanation")
            })
            container.appendChild(explainButton);

            // 根据随机顺序为每个选项重新分配编号（从 1 开始）
            let newCorrectNumber = '';
            optionObjects.forEach((optionObj, index) => {
                const newNumber = (index + 1).toString();
                // 如果原始选项编号与本题正确答案一致，则新的正确答案编号更新为当前 newNumber
                if (optionObj.originalNumber === block.correctAnswer) {
                    newCorrectNumber = newNumber;
                }
                // 生成单个选项（label 内包含隐藏的 radio 和选项文本）
                const label = document.createElement('label');
                label.className = 'radio-label';
                const input = document.createElement('input');
                input.type = 'radio';
                // 每题的 radio 组名使用不同标识，保证互斥性
                input.name = 'answer' + blockIndex;
                input.setAttribute('onclick', `handleChoice(this, '${newNumber}')`);
                label.appendChild(input);
                // 添加选项编号（例如 "1. "）
                label.appendChild(document.createTextNode(newNumber + '. '));
                // 包裹选项内容的 span
                const span = document.createElement('span');
                span.className = 'answer';
                span.textContent = optionObj.answerContent;
                label.appendChild(span);
                // label点击事件
                label.addEventListener('click', (event) => {
                    // 如果ctrl键已经按下, 则获取inputCount的值, 并将span.textContent重复对应的次数
                    if (event.ctrlKey || ctrlCheckBox.checked) {
                        const count = parseInt(inputCount.value);
                        if(count > 0){
                            const repeatedText = `${span.textContent} `.repeat(count);
                            // console.log(repeatedText)
                            play(repeatedText)
                        }
                    } else {
                        play(span.textContent)
                    }
                    if (hideButton.textContent === "show") { //  !listenCheckBox.checked
                        hideButton.click()
                    }
                });
                container.appendChild(label);
            });

            // 设置当前组件的正确答案编号
            container.setAttribute('data-correct-answer', newCorrectNumber);
            choiceField.appendChild(container);

            // 为复制按钮添加点击事件
            copyButton.addEventListener('click', () => {
                const questionText = container.querySelector('.questionText').innerText;
                const answers = Array.from(container.querySelectorAll('.radio-label'))
                    .map(label => label.innerText.trim());
                const textToCopy = `${questionText}\n${answers.join("\n")}`;
                fallbackCopyText(textToCopy);
                copyButton.innerText = 'copied';
                setTimeout(() => {
                    copyButton.innerText = 'copy';
                }, 1000);
            });

            if (hideCheckbox.checked) {
                hideButton.click()
            }

            playButton.addEventListener('click', () => {
                currentIndex = blockIndex
                play(readText)
                const items = optionContent.split(/\d+\.\s/);
                const result = items.filter(item => item.trim() !== '');
                currentText = []
                currentText = result
                currentContainer = []
                // 将container中的所有label子标签过滤到currentContainer中
                currentContainer = container.querySelectorAll('label');
            });

            playButton1.addEventListener('click', () => {
                currentIndex = blockIndex
                play(block.questionText)
                const items = optionContent.split(/\d+\.\s/);
                const result = items.filter(item => item.trim() !== '');
                currentText = []
                currentText = result
                currentContainer = []
                // 将container中的所有label子标签过滤到currentContainer中
                currentContainer = container.querySelectorAll('label');
            });
        });
    }

    // 当点击“确认”按钮时，读取 textarea 内容，生成多个选择题组件
    document.getElementById('btnConfirm').addEventListener('click', () => {
        const rawText = document.getElementById('choiceInput').value;
        if (rawText) {
            localStorage.setItem('rawText', rawText);
        }
        buildMultipleChoiceComponents(rawText);
        document.getElementById('choiceInput').value = '';
        // frontContent滑倒最顶部
        frontContent.scrollTop = 0;
    });

    if (localStorage.getItem('rawText')) {
        buildMultipleChoiceComponents(localStorage.getItem('rawText'));
    }

    // document.getElementById('btnInsertCode').addEventListener('click', () => {
    //     const rawText = document.getElementById('choiceInput').value;
    //     code.textContent = rawText;
    //     code.className = `language-tsx`;
    //     document.getElementById('choiceInput').value = '';
    //     // Manually trigger Prism.js to highlight the inserted code
    //     hljs.highlightElement(code);
    // });
</script>
</body>
</html>
