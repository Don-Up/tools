<div id="front-content" style="height: 80vh;display: flex;justify-items: center;align-items: center">
    <div style="margin-left: auto;margin-right: auto;">
        <div style="display: flex; flex-direction: column; align-items: center;gap: 20px">
            <h1 id="front" style="text-align: center">{{Front}}</h1>
            {{Code}}
            <div id="answer">{{Answer}}</div>
        </div>
    </div>
</div>

<script>
    function init(){
        let answer = document.getElementById('answer');
        let originalText = answer.textContent;
        if (!originalText.includes("~")) {
            answer.innerHTML = `<input placeholder='${originalText}'>`
        } else {
            let newHTML = originalText.replace(/~~/g, '">').replace(/~/g, `<input placeholder="`).replace(/；/g, '<br>').replace(/;/g, '<br>');
            answer.innerHTML = newHTML;
        }
        var initialInputLength = 0
        document.querySelectorAll('input').forEach((input, index) => {
            input.placeholder = input.placeholder.trim();

            const length = input.placeholder.length//input.getAttribute('placeholder').length
            let width = Math.max(length * 20, 100)
            width = Math.min(width, 1000)
            input.style.width = width + 'px'

            input.dataset.charIndex = 0; // 初始化字符索引为0
            input.dataset.wordIndex = 0;
            input.value = input.placeholder.substring(0, initialInputLength)
            input.dataset.charIndex = input.value.length;
            if (index === 0) {
                input.focus()
            }
            // 监听输入事件
            input.addEventListener('input', () => {
                const targetString = input.placeholder; // 使用 placeholder 作为目标字符串
                const userInput = input.value;

                // 更新字符索引为当前输入字符数
                input.dataset.charIndex = userInput.length;

                // 只有当 placeholder 存在时才进行颜色变换
                if (userInput.toLowerCase() === targetString.toLowerCase()) {
                    input.className = 'orange'; // 完全正确
                } else if (targetString.startsWith(userInput)) {
                    input.className = 'green'; // 前缀正确/容错通过
                    // Replace the existing conditions with these:
                    if (targetString.startsWith(userInput + " the ")) {
                        input.value = userInput + " the ";
                        let charIndex = parseInt(input.dataset.charIndex, 10);
                        input.dataset.charIndex = charIndex + 5
                    } else if (targetString.startsWith(userInput + " ")) {
                        input.value = userInput + " ";
                        let charIndex = parseInt(input.dataset.charIndex, 10);
                        input.dataset.charIndex = charIndex + 1
                    }
                } else {
                    input.className = 'red'; // 错误
                }

            });

            // 监听获取焦点事件
            input.addEventListener('focus', () => {
                input.dataset.charIndex = input.value.length; // 设置charIndex为当前输入字符数
                const length = input.value.length;
                input.setSelectionRange(length, length);
            });

            // 处理点击事件
            input.addEventListener('click', () => {
                event.preventDefault();
                const placeholderValue = input.placeholder;
                let charIndex = parseInt(input.dataset.charIndex, 10); // 获取当前字符索引

                if (placeholderValue && charIndex < placeholderValue.length) {
                    input.value += placeholderValue.charAt(charIndex); // 添加当前字符
                    charIndex++; // 更新字符索引
                    input.dataset.charIndex = charIndex; // 存储新的索引
                    if (charIndex === input.placeholder.length) {
                        input.className = 'orange';
                    }
                }
            });

            input.addEventListener('keydown', (event) => {
                if (document.activeElement === input) {
                    if (event.key === '`') {
                        event.preventDefault();
                        let charIndex = parseInt(input.dataset.charIndex, 10); // 获取当前字符索引

                        if (input.placeholder && charIndex < input.placeholder.length) {
                            input.value += input.placeholder.charAt(charIndex); // 添加当前字符
                            charIndex++; // 更新字符索引
                            input.dataset.charIndex = charIndex; // 存储新的索引
                            if (charIndex === input.placeholder.length) {
                                input.className = 'orange';
                            }
                        }
                    } else if (event.key === 'F4') {
                        document.querySelectorAll('input').forEach(input => {
                            input.value = answer.substring(0, initialInputLength)
                        })
                    } else if (event.key === 'F3') {
                        input.blur()
                    } else if (event.key === 'F2') {
                        input.value = input.placeholder; // 显示完整的placeholder值
                        input.dataset.charIndex = input.placeholder.length; // 更新字符索引为placeholder的长度
                        input.className = 'orange';
                    }
                }
            });

            // 处理长按显示完整的 placeholder
            let longPressTimeout;

            input.addEventListener('mousedown', () => {
                longPressTimeout = setTimeout(() => {
                    const placeholderValue = input.placeholder;
                    input.value = placeholderValue; // 显示完整的placeholder值
                    input.dataset.charIndex = placeholderValue.length; // 更新字符索引为placeholder的长度
                    input.className = 'orange';
                }, 600); // 设置长按时间，例如600毫秒
            });

            input.addEventListener('mouseup', () => {
                clearTimeout(longPressTimeout); // 取消长按显示操作
            });

            input.addEventListener('mouseleave', () => {
                clearTimeout(longPressTimeout); // 取消长按显示操作
            });

        });
    }

    function setupTTS() {
        // 朗读指定文本
        function speakText(text) {
            if (!text) return;

            // 停止当前播放（防止堆积）
            window.speechSynthesis.cancel();

            const filteredText = filterText(text);
            const utterance = new SpeechSynthesisUtterance(filteredText);
            utterance.rate = 2;

            function findVoice() {
                const voices = window.speechSynthesis.getVoices();
                return voices.find(v =>
                    v.name === "Microsoft Yaoyao - Chinese (Simplified, PRC)" &&
                    v.lang === "zh-CN"
                );
            }

            // 尝试找到指定语音
            let voice = findVoice();
            if (voice) {
                utterance.voice = voice;
                window.speechSynthesis.speak(utterance);
            } else {
                // 等待语音加载
                window.speechSynthesis.onvoiceschanged = () => {
                    voice = findVoice();
                    utterance.voice = voice || null;
                    utterance.lang = voice ? voice.lang : "zh-CN";
                    window.speechSynthesis.speak(utterance);
                    // 移除监听器，防止多次触发
                    window.speechSynthesis.onvoiceschanged = null;
                };
            }
        }

        // 过滤文本函数
        function filterText(text) {
            let filtered = text.split('。')[0];
            filtered = filtered.replace(/[\(\[\{〈《「『【].*?[\)\]\}〉》」』】]/g, '');
            return filtered.trim();
        }

        // 获取文本内容
        const front = document.querySelector("#front");
        if (front) {
            const title = front.innerText || front.textContent;
            speakText(title);
        }
    }

    // ✅ 保证每次显示新卡时都重新朗读
    if (typeof ankiDeckObserverAttached === "undefined") {
        document.addEventListener("anki-show", () => {
            init();
            setupTTS();
        });
        window.ankiDeckObserverAttached = true;
    }

    init()
    // 立即执行一次（用于首张卡片）
    setupTTS();
</script>